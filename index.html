<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NeuroGallery -- AI Art Collection</title>
<style>
:root{
  --bg:#101319;--card:#181c24;--text:#f3f6fa;--muted:#a8b0ba;
  --accent:#00eaff;--border:rgba(255,255,255,0.12);
  --gold:#ffd166;--ok:#19d18a;--bad:#ff5c5c;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif;min-height:100vh;}
header{
  position:fixed;top:0;left:0;width:100%;
  background:rgba(16,19,25,0.9);backdrop-filter:blur(8px);
  border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 20px;z-index:10;
}
h1{margin:0;color:var(--accent);font-size:1.2rem;text-shadow:0 0 10px var(--accent);}
nav a{color:var(--text);margin:0 10px;text-decoration:none;font-weight:600;transition:.3s;}
nav a:hover{color:var(--accent);}
main{max-width:1200px;margin:100px auto 60px;padding:0 16px;}
#uploadInput{display:none;}
button{cursor:pointer;border:none;border-radius:8px;padding:8px 14px;font-weight:700;}
.btn{background:var(--accent);color:#000;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;position:relative;}
.card img{width:100%;height:200px;object-fit:cover;cursor:pointer;}
.meta{padding:10px;font-size:.9rem;color:var(--muted);}
footer{text-align:center;color:var(--muted);padding:20px 0;border-top:1px solid var(--border);}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:100;}
.modal.active{display:flex;}
.modal-content{position:relative;max-width:90%;max-height:90%;}
.modal-content img{width:100%;height:auto;border-radius:10px;}
.modal button{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:50%;width:40px;height:40px;font-size:1.5rem;}
.modal .close{top:20px;right:20px;transform:none;}
.modal .prev{left:-60px;}
.modal .next{right:-60px;}
.download-btn{margin-top:10px;background:var(--accent);color:#000;padding:6px 12px;border-radius:6px;text-decoration:none;font-weight:700;}
.stats{margin-bottom:20px;font-size:.9rem;color:var(--muted);}
</style>
</head>
<body>

<header>
  <h1>NeuroGallery</h1>
  <nav>
    <a href="#" id="aboutBtn">About</a>
    <label class="btn" for="uploadInput">Upload</label>
    <input type="file" id="uploadInput" multiple accept="image/*">
  </nav>
</header>

<main>
  <div class="stats" id="stats"></div>
  <div class="grid" id="gallery"></div>
</main>

<footer>All images are AI-generated. Free for personal use. © NeuroGallery</footer>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <img id="modalImg" src="">
    <button class="close" id="closeBtn">✕</button>
    <button class="prev" id="prevBtn">⟨</button>
    <button class="next" id="nextBtn">⟩</button>
    <div style="text-align:center;margin-top:10px;">
      <a id="downloadBtn" class="download-btn" download>Download</a>
    </div>
  </div>
</div>

<script type="module">
import { db, storage } from './firebase-config.js';
import { collection, addDoc, serverTimestamp, query, where, orderBy, onSnapshot, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

const gallery = document.getElementById("gallery");
const uploadInput = document.getElementById("uploadInput");
const modal = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");
const closeBtn = document.getElementById("closeBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const downloadBtn = document.getElementById("downloadBtn");
const stats = document.getElementById("stats");

let images = [];
let currentIndex = 0;

/* ---- Upload ---- */
uploadInput.addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files);
  for(const file of files){
    const storageRef = ref(storage, "uploads/"+file.name);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    await addDoc(collection(db, "images"), {
      url,
      title:file.name,
      status:"pending",
      createdAt: serverTimestamp(),
      views:0,
      downloads:0
    });
  }
  alert("Uploaded! Waiting for admin approval.");
});

/* ---- Load approved images ---- */
const q = query(collection(db, "images"), where("status", "==", "approved"), orderBy("createdAt", "desc"));
onSnapshot(q, (snap)=>{
  images = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  renderGallery();
});

/* ---- Render ---- */
function renderGallery(){
  stats.innerHTML = `🖼️ Total: ${images.length}`;
  gallery.innerHTML = "";
  images.forEach((img,i)=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `<img src="${img.url}" alt=""><div class="meta">${img.title||''}</div>`;
    card.querySelector("img").onclick = ()=> openModal(i);
    gallery.appendChild(card);
  });
}

/* ---- Modal ---- */
function openModal(index){
  currentIndex=index;
  const img=images[index];
  modalImg.src=img.url;
  modal.classList.add("active");
  downloadBtn.href=img.url;
  updateViews(img.id, img.views);
}
function closeModal(){modal.classList.remove("active");}
function prev(){if(currentIndex>0)openModal(currentIndex-1);}
function next(){if(currentIndex<images.length-1)openModal(currentIndex+1);}

closeBtn.onclick=closeModal;
prevBtn.onclick=prev;
nextBtn.onclick=next;

/* ---- Update views ---- */
async function updateViews(id,views){
  await updateDoc(doc(db,"images",id),{views:(views||0)+1});
}

/* ---- Download tracking ---- */
downloadBtn.addEventListener("click",async ()=>{
  const img=images[currentIndex];
  await updateDoc(doc(db,"images",img.id),{downloads:(img.downloads||0)+1});
});
</script>

</body>
</html>      <button id="copyPrompt" class="btn">Copy Prompt</button>
        <button id="downloadBtn" class="btn">Download</button>
        <span id="copyState" class="small"></span>
      </div>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
  <div class="sheet">
    <h3>Upload AI Artwork</h3>
    <div class="f">
      <input type="file" id="upFile" accept="image/*" />
      <input type="text" id="upTitle" placeholder="Title (e.g., Golden Knight on Mars)" />
      <select id="upCat">
        <option>Sci-Fi</option><option>Fantasy</option><option>Cyberpunk</option>
        <option>Nature</option><option>Abstract</option>
      </select>
      <textarea id="upPrompt" placeholder="Prompt used to generate this image…"></textarea>
      <div class="row">
        <button id="upSave" class="btn">Save</button>
        <button id="upCancel" class="btn">Cancel</button>
      </div>
      <span class="small">Uploads require admin approval before appearing on the site.</span>
    </div>
  </div>
</div>

<script type="module">
import {
  app, auth, provider, signInWithPopup, signOut, onAuthStateChanged,
  db, storage,
  collection, addDoc, doc, query, where, orderBy, onSnapshot, updateDoc, deleteDoc, serverTimestamp,
  ref, uploadBytes, getDownloadURL
} from './firebase-config.js';

/* ---------- UI refs ---------- */
const grid = document.getElementById('grid');
const filters = document.getElementById('filters');
const search = document.getElementById('search');
const aboutBtn = document.getElementById('aboutBtn');
const about = document.getElementById('about');
const signBtn = document.getElementById('signBtn');
const uploadBtn = document.getElementById('uploadBtn');
const upModal = document.getElementById('uploadModal');
const upFile = document.getElementById('upFile');
const upTitle = document.getElementById('upTitle');
const upCat = document.getElementById('upCat');
const upPrompt = document.getElementById('upPrompt');
const upSave = document.getElementById('upSave');
const upCancel = document.getElementById('upCancel');

let currentFilter = 'All';
let currentIndex = 0;
let currentViewList = [];
let unsubQuery = null;

/* ---------- Auth ---------- */
onAuthStateChanged(auth, (user) => {
  if (user) {
    signBtn.textContent = `Sign out (${user.displayName||user.email})`;
    uploadBtn.classList.remove('hidden');
  } else {
    signBtn.textContent = 'Sign in with Google';
    uploadBtn.classList.add('hidden');
  }
});
signBtn.onclick = async () => {
  if (auth.currentUser) { await signOut(auth); return; }
  await signInWithPopup(auth, provider);
};

/* ---------- Query & Render ---------- */
function startLiveQuery(){
  if (unsubQuery) { unsubQuery(); unsubQuery = null; }
  const q = query(
    collection(db, 'images'),
    where('status', '==', 'approved'),
    orderBy('createdAt', 'desc')
  );
  unsubQuery = onSnapshot(q, (snap)=>{
    const data = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderList(data);
  });
}
startLiveQuery();

function renderList(items){
  const term = (search.value||'').toLowerCase();
  const filtered = items.filter(it=>{
    const catOk = currentFilter==='All' || it.cat===currentFilter;
    const qOk = !term || (it.title||'').toLowerCase().includes(term) || (it.prompt||'').toLowerCase().includes(term);
    return catOk && qOk;
  });
  currentViewList = filtered;
  grid.innerHTML = '';
  filtered.forEach((it, idx)=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img class="thumb" src="${it.url}" alt="${it.title||''}" />
      <div class="meta">
        <div class="title">${it.title||'Untitled'}</div>
        <div class="small">Cat: ${it.cat||'--'}</div>
        <div class="small">Prompt: ${(it.prompt||'').slice(0,90)}${(it.prompt||'').length>90?'…':''}</div>
        <div class="row">
          <button class="btn view">View</button>
          <button class="btn dl">Download</button>
        </div>
      </div>`;
    const img = card.querySelector('.thumb');
    img.addEventListener('click', ()=>openViewer(idx));
    card.querySelector('.view').onclick = ()=>openViewer(idx);
    card.querySelector('.dl').onclick = ()=>downloadItem(idx);
    grid.appendChild(card);
  });
}

/* ---------- Filters/Search/About ---------- */
filters.addEventListener('click', (e)=>{
  const b = e.target.closest('.filter'); if(!b) return;
  document.querySelectorAll('.filter').forEach(el=>el.classList.remove('active'));
  b.classList.add('active');
  currentFilter = b.dataset.cat;
  startLiveQuery();
});
search.oninput = ()=> startLiveQuery();
aboutBtn.onclick = ()=>{
  about.style.display = (about.style.display==='block') ? 'none' : 'block';
  if(about.style.display==='block') about.scrollIntoView({behavior:'smooth', block:'start'});
};

/* ---------- Viewer ---------- */
const viewer = document.getElementById('viewer');
const vwImg = document.getElementById('vwImg');
const vwTitle = document.getElementById('vwTitle');
const vwCat = document.getElementById('vwCat');
const vwPrompt = document.getElementById('vwPrompt');
const copyState = document.getElementById('copyState');

function openViewer(idx){
  currentIndex = idx;
  const it = currentViewList[idx];
  vwImg.src = it.url;
  vwTitle.textContent = it.title||'';
  vwCat.textContent = it.cat||'';
  vwPrompt.textContent = it.prompt||'';
  copyState.textContent = '';
  viewer.style.display = 'flex';
}
document.getElementById('closeBtn').onclick = ()=> viewer.style.display='none';
document.getElementById('prevBtn').onclick = ()=> { currentIndex = (currentIndex-1+currentViewList.length)%currentViewList.length; openViewer(currentIndex); };
document.getElementById('nextBtn').onclick = ()=> { currentIndex = (currentIndex+1)%currentViewList.length; openViewer(currentIndex); };
document.getElementById('copyPrompt').onclick = async ()=>{
  try{ await navigator.clipboard.writeText(vwPrompt.textContent); copyState.textContent='Copied ✓'; copyState.className='small copy-ok'; }
  catch{ copyState.textContent='Copy failed'; copyState.className='small'; }
};
document.getElementById('downloadBtn').onclick = ()=>{
  const it = currentViewList[currentIndex];
  const a = document.createElement('a');
  a.href = it.url;
  a.download = (it.title||'image').replace(/\s+/g,'_') + '.png';
  document.body.appendChild(a); a.click(); a.remove();
};
function downloadItem(idx){
  const it = currentViewList[idx];
  const a = document.createElement('a');
  a.href = it.url;
  a.download = (it.title||'image').replace(/\s+/g,'_') + '.png';
  document.body.appendChild(a); a.click(); a.remove();
}

/* ---------- Upload flow (auth required) ---------- */
uploadBtn.onclick = ()=>{
  if(!auth.currentUser){ alert('Please sign in with Google to upload.'); return; }
  upModal.style.display = 'flex';
};
upCancel.onclick = ()=> upModal.style.display='none';

upSave.onclick = async ()=>{
  try{
    if(!auth.currentUser){ alert('Sign in first'); return; }
    const file = upFile.files[0];
    if(!file){ alert('Choose an image'); return; }
    const title = upTitle.value.trim() || file.name;
    const cat = upCat.value;
    const prompt = upPrompt.value.trim() || '';

    const ts = Date.now();
    const path = `uploads/${auth.currentUser.uid}/${ts}_${file.name}`;
    const storageRef = ref(storage, path);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);

    await addDoc(collection(db, 'images'), {
      title, cat, prompt,
      url, storagePath: path,
      uid: auth.currentUser.uid,
      author: auth.currentUser.displayName || auth.currentUser.email || 'Unknown',
      status: 'pending',
      createdAt: serverTimestamp()
    });

    upModal.style.display='none';
    upFile.value=''; upTitle.value=''; upPrompt.value='';
    alert('Uploaded! Pending admin approval.');
  }catch(err){
    console.error(err);
    alert('Upload failed: '+err.message);
  }
};
</script>
</body>
</html>